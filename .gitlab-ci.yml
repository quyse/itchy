# Gitlab CI config for itchy

before_script:
- git submodule foreach git clean -xfd
- git submodule init
- git submodule update

stages:
- build
- image

binaries:
  stage: build
  script:
  - "mkdir itchy"
  - "npm install"
  - "stack --no-terminal build --test --copy-bins --local-bin-path itchy"
  artifacts:
    paths:
    - itchy
    expire_in: 1 week
  tags:
  - haskellstack
  - linux
  - x64

itchyd-image:
  stage: image
  image: docker:git
  services:
  - docker:dind
  dependencies:
  - binaries
  variables:
    REPO: registry.gitlab.com/quyse/itchy:latest
    DOCKER_DRIVER: overlay
  script:
  - "mv itchy/itchyd containers/itchyd/"
  - "docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com"
  - "docker build -t $REPO -f containers/itchyd/Dockerfile containers/itchyd"
  - "docker push $REPO"
  tags:
  - linux
  - shared

runner-image:
  stage: image
  image: docker:git
  services:
  - docker:dind
  dependencies:
  - binaries
  variables:
    REPO: registry.gitlab.com/itchy-bot/itch-builds:latest
    DOCKER_DRIVER: overlay
  script:
  - "mv itchy/itchy-runner containers/runner/"
  - "docker login -u gitlab-ci-token -p $GITLAB_REGISTRY_ITCHY_TOKEN registry.gitlab.com"
  - "docker build -t $REPO -f containers/runner/Dockerfile containers/runner"
  - "docker push $REPO"
  tags:
  - linux
  - shared
